# 011 - 프롬프트 상세 페이지 및 구매 로직 구현

## 1. 목표 (Goal)
- `/prompts/[id]` 동적 라우트로 프롬프트 상세 페이지 구현
- 구매 여부에 따른 콘텐츠 접근 분기 (미리보기 vs 전체 본문)
- Supabase RPC 함수로 조회수 증가 및 구매 트랜잭션 처리
- 판매자/구매자/비로그인 사용자 각각 다른 UI 표시

## 2. 추론 및 결정 (Reasoning & Decisions)

### 콘텐츠 접근 제어
- **판매자 본인**: 본문 전체 공개 + "내 프롬프트" 배지
- **구매 완료 사용자**: 본문 전체 공개 + "구매 완료" 배지
- **미구매 사용자**: 미리보기만 표시 + 본문 영역에 자물쇠 아이콘 + 구매 버튼
- **비로그인 사용자**: 미리보기만 표시 + "로그인 후 구매" 버튼 (redirect 파라미터 포함)

### 조회수 증가 - SECURITY DEFINER RPC
- 기존 RLS 정책상 `prompts_update`는 `auth.uid() = seller_id`로 제한됨
- 일반 사용자가 view_count를 직접 UPDATE할 수 없는 구조
- `SECURITY DEFINER` 함수로 RLS를 우회하여 조회수 증가 처리
- 실패해도 사용자 경험에 영향 없도록 `.catch(() => {})` 처리

### 구매 트랜잭션 - purchase_prompt RPC
- 5단계 원자적 트랜잭션으로 데이터 일관성 보장:
  1. 자기 프롬프트 구매 차단
  2. 중복 구매 확인
  3. 포인트 잔액 확인
  4. 포인트 차감(구매자) / 지급(판매자)
  5. 구매 기록 생성 + 판매 카운트 증가
- `SECURITY DEFINER`로 모든 테이블에 쓰기 가능
- 에러 메시지로 실패 원인 구분 (`already purchased`, `insufficient points`, `cannot purchase own prompt`)

### 레이아웃: 2/3 + 1/3 그리드
- 좌측 메인(2/3): 제목, 설명, 미리보기, 본문, 태그
- 우측 사이드바(1/3): 가격 + 구매 버튼, 판매자 정보, 통계
- 모바일에서는 1열로 전환 (사이드바가 아래로)

### 빈 상태 / 에러 처리
- **로딩 중**: 중앙 스피너
- **404 (프롬프트 없음)**: AlertCircle 아이콘 + 목록 복귀 버튼
- **서버 에러**: 새로고침 버튼
- **구매 실패**: 사이드바 내 에러 메시지

## 3. 구현 상세 (Implementation Details)

### 3-1. 추가/수정된 파일

| 파일 | 변경 내용 |
|------|-----------|
| `app/prompts/[id]/page.tsx` | **신규** - 프롬프트 상세 페이지 |
| `supabase/migrations/002_rpc_functions.sql` | **신규** - RPC 함수 2개 (조회수, 구매) |

### 3-2. 페이지 레이아웃

```
┌──────────────────────────────────────────────┐
│ ← 목록으로                                    │
├──────────────────────────┬───────────────────┤
│ [카테고리] [내 프롬프트]  │  ┌─────────────┐ │
│                          │  │    가격      │ │
│ 제목                     │  │  1,000 F     │ │
│ 설명                     │  │ [구매하기]    │ │
│                          │  │ 보유: 500 F  │ │
│ ── 미리보기 ──            │  └─────────────┘ │
│ ┌──────────────────────┐ │                   │
│ │  미리보기 콘텐츠      │ │  ┌─────────────┐ │
│ │  (그라데이션 배경)    │ │  │  판매자      │ │
│ └──────────────────────┘ │  │  [아바타]     │ │
│                          │  │  닉네임 🥉   │ │
│ ── 프롬프트 본문 ──       │  └─────────────┘ │
│ ┌──────────────────────┐ │                   │
│ │  🔒 구매 후 열람 가능 │ │  ┌─────────────┐ │
│ │  (또는 전체 본문)     │ │  │  통계        │ │
│ └──────────────────────┘ │  │ 👁 1.2K 🛒 45│ │
│                          │  │ 📅 등록일     │ │
│ #태그1 #태그2            │  └─────────────┘ │
└──────────────────────────┴───────────────────┘
```

### 3-3. 사용자 상태별 UI

| 상태 | 본문 | 구매 영역 |
|------|------|-----------|
| 판매자 본인 | 전체 공개 | "내가 등록한 프롬프트" 안내 |
| 구매 완료 | 전체 공개 | "구매 완료" 체크 표시 |
| 로그인 (미구매) | 자물쇠 | 구매 버튼 + 보유 포인트 |
| 비로그인 | 자물쇠 | "로그인 후 구매" 링크 |

### 3-4. RPC 함수 (002_rpc_functions.sql)

#### increment_view_count
```sql
function increment_view_count(prompt_id uuid) returns void
-- ACTIVE 상태인 프롬프트의 view_count를 1 증가
-- SECURITY DEFINER로 RLS 우회
```

#### purchase_prompt
```sql
function purchase_prompt(
  p_buyer_id uuid, p_prompt_id uuid,
  p_seller_id uuid, p_price integer
) returns void
-- 원자적 구매 트랜잭션
-- 포인트 차감/지급 + 구매 기록 + 카운트 업데이트
-- SECURITY DEFINER로 RLS 우회
```

**적용 방법**: Supabase Dashboard > SQL Editor에서 `002_rpc_functions.sql` 내용 실행

## 4. 기존 인프라 활용

| 기존 코드 | 활용 |
|-----------|------|
| `PromptWithSeller` 타입 | JOIN 결과 타입 |
| `CATEGORIES`, `TIERS` | 카테고리/등급 표시 |
| `formatPoints()` | 가격, 보유 포인트 표시 |
| `formatDateTime()` | 등록일 표시 |
| `formatCompactNumber()` | 조회수/판매수 축약 |
| `useAuthStore()` | 로그인 사용자 정보 + 포인트 잔액 |
| `ROUTES` | 링크 경로 |
| `purchases` 테이블 | 구매 여부 확인 |

## 5. 다음 단계 (Next Steps)

- **012 - 프로필 페이지**: 마이페이지, 내 프롬프트 관리, 구매 내역
- **013 - 추가 개선**: 프롬프트 수정/삭제, 포인트 충전, 검색 고도화
